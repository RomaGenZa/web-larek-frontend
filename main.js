(()=>{"use strict";const t="https://larek-api.nomoreparties.co/content/weblarek",e={didLoadProducts:"products:did_load_products",didFindProductById:"did_find_product_by_id"},i={itemsChanged:"cart:items_changed",addItem:"cart:item_add",removeItem:"cart:item_remove",initOrderCreation:"cart:init_order_creation",clearCart:"cart:clear_cart"},s={collectPaymentInfo:"order:collect_payment_info",collectContactInfo:"order:collect_contact_info",finishCreation:"order:creation_finished",created:"order:created",notcreated:"order:notcreated",didChangeAddressInput:"order:did_change_address_input",addressValidation:"order:address_validation",phoneValidation:"order:phone_validation",emailValidation:"order:email_validation",paymentValidation:"order:payment_validation",didSelectPaymentType:"order:did_select_payment_type",didChangeEmailInput:"order:did_change_email_input",didChangePhoneInput:"order:did_change_phone_input"},n={didClickOpenCart:"page:did_click_open_cart",didSelectItem:"page:did_select_item"},r={close:"modal_close",openCardPreview:"modal_open_card_preview"};function isSelector(t){return"string"==typeof t&&t.length>1}function ensureElement(t,e){if(isSelector(t)){const i=function ensureAllElements(t,e=document){if(isSelector(t))return Array.from(e.querySelectorAll(t));if(t instanceof NodeList)return Array.from(t);if(Array.isArray(t))return t;throw new Error("Unknown selector element")}(t,e);if(i.length>1&&console.warn(`selector ${t} return more then one element`),0===i.length)throw new Error(`selector ${t} return nothing`);return i.pop()}if(t instanceof HTMLElement)return t;throw new Error("Unknown selector element")}function cloneTemplate(t){return ensureElement(t).content.firstElementChild.cloneNode(!0)}class PageHeader{constructor(t,e){this.openCartButton=t.querySelector(".header__basket"),this.productsInCartCount=t.querySelector(".header__basket-counter"),this.eventBroker=e,this.eventBroker.on(i.itemsChanged,(t=>{this.updateCounter(t)})),this.openCartButton.addEventListener("click",(()=>{this.onCartButtonClick()}))}onCartButtonClick(){this.eventBroker.emit(n.didClickOpenCart)}updateCounter(t){this.productsInCartCount.textContent=t.length.toString()}}var a,o,l;function productCategoryToClassName(t){switch(t){case o.Additional:return"card__category_additional";case o.Button:return"card__category_button";case o.HardSkill:return"card__category_hard";case o.Other:return"card__category_other";case o.SoftSkill:return"card__category_soft"}}!function(t){t.Online="online",t.Cash="cash"}(a||(a={})),function(t){t.Additional="дополнительное",t.Button="кнопка",t.HardSkill="хард-скил",t.Other="другое",t.SoftSkill="софт-скил"}(o||(o={}));class ProductCard{get id(){return this.element.id}constructor(t,e){this.eventsBroker=e,this.element=cloneTemplate(t),this.category=this.element.querySelector(".card__category"),this.title=this.element.querySelector(".card__title"),this.image=this.element.querySelector(".card__image"),this.price=this.element.querySelector(".card__price"),this.element.addEventListener("click",(()=>{console.log("Did select item "+this),e.emit(n.didSelectItem,this)}))}setData(t){this.element.id=t.id,this.image.src=t.image,this.image.alt=t.title,this.title.textContent=t.title,this.clearCategory(),this.category.classList.add(productCategoryToClassName(t.category)),this.category.textContent=t.category,null===t.price?this.price.textContent="Бесценно":this.price.textContent=t.price.toString()+" синапсов"}render(){return this.element}clearCategory(){for(const t in o)this.category.classList.remove(productCategoryToClassName(t))}}class PageGallery{constructor(t,i){this.element=t,this.eventsBroker=i,this.cards=[],this.eventsBroker.on(e.didLoadProducts,(t=>{this.updateData(t)}))}updateData(t){t.forEach((t=>{const e=document.querySelector("#card-catalog"),i=new ProductCard(e,this.eventsBroker);i.setData(t),this.cards.push(i),this.element.append(i.render())}))}}class ModalContainer{constructor(t,e){this.element=t,this.closeButton=t.querySelector(".modal__close"),this.contentContainer=t.querySelector(".modal__content"),this.closeButton.addEventListener("click",(()=>{e.emit(r.close)}))}setContent(t){this.content&&(this.content.dispose(),this.content=null),this.contentContainer.appendChild(t.render()),this.content=t}open(){this.element.classList.add("modal_active")}close(){this.content.dispose(),this.content=null,this.element.classList.remove("modal_active")}}class ProductCardPreview{constructor(t,e){this.element=cloneTemplate(t),this.eventsBroker=e,this.category=this.element.querySelector(".card__category"),this.title=this.element.querySelector(".card__title"),this.image=this.element.querySelector(".card__image"),this.price=this.element.querySelector(".card__price"),this.description=this.element.querySelector(".card__text"),this.addToCartButton=this.element.querySelector(".card__button")}setData(t){this.image.src=t.image,this.image.alt=t.title,this.title.textContent=t.title,this.clearCategory(),this.category.classList.add(productCategoryToClassName(t.category)),null===t.price?this.price.textContent="Бесценно":this.price.textContent=t.price.toString()+" синапсов",this.description.innerHTML=t.description,this.addToCartButton.addEventListener("click",(()=>{this.eventsBroker.emit(i.addItem,t)}))}render(){return this.element}dispose(){this.element.remove(),this.element=null}clearCategory(){for(const t in o)this.category.classList.remove(productCategoryToClassName(t))}}class Cart{constructor(t,e,s){this.cartListItem=e,this.element=cloneTemplate(t),this.itemsList=this.element.querySelector(".basket__list"),this.price=this.element.querySelector(".basket__price"),this.createOrderButton=this.element.querySelector(".basket__button"),this.cartItems=[],s.on(i.itemsChanged,(t=>{this.setData(t)})),this.createOrderButton.addEventListener("click",(()=>{s.emit(i.initOrderCreation)}))}setData(t){this.clearData(),this.cartItems=t.map(((t,e)=>{const i=this.cartListItem.clone();return i.setData(e+1,t),this.itemsList.append(i.render()),i})),t.some((t=>null==t.price))?(this.price.textContent="Не расплатишься",this.createOrderButton.disabled=!0):(this.price.textContent=t.reduce(((t,e)=>t+e.price),0).toString()+" синапсов",this.createOrderButton.disabled=!1)}render(){return this.element}dispose(){this.clearData(),this.element.remove(),this.element=null}clearData(){this.cartItems.forEach((t=>t.dispose()))}}class PaymentInfo{constructor(t,e){this.buttonActiveClass="button_alt-active",this.buttonInactiveClass="button_alt",this.element=cloneTemplate(t),this.buttonCashPayment=this.element.querySelector('button[name="cash"]'),this.buttonOnlinePayment=this.element.querySelector('button[name="card"]'),this.buttonNext=this.element.querySelector(".order__button"),this.addressInput=this.element.querySelector('input[name="address"]'),this.errorMessage=this.element.querySelector(".form__errors"),this.element.addEventListener("submit",(t=>{t.preventDefault(),e.emit(s.collectContactInfo)})),this.addressInput.addEventListener("input",(()=>{e.emit(s.didChangeAddressInput,{input:this.addressInput.value})})),e.on(s.addressValidation,(t=>{this.validate(t)})),e.on(s.paymentValidation,(t=>{this.validate(t)})),this.buttonCashPayment.addEventListener("click",(()=>{e.emit(s.didSelectPaymentType,{type:a.Cash}),this.buttonOnlinePayment.classList.remove(this.buttonActiveClass),this.buttonOnlinePayment.classList.add(this.buttonInactiveClass),this.buttonCashPayment.classList.remove(this.buttonInactiveClass),this.buttonCashPayment.classList.add(this.buttonActiveClass)})),this.buttonOnlinePayment.addEventListener("click",(()=>{e.emit(s.didSelectPaymentType,{type:a.Online}),this.buttonCashPayment.classList.remove(this.buttonActiveClass),this.buttonCashPayment.classList.add(this.buttonInactiveClass),this.buttonOnlinePayment.classList.remove(this.buttonInactiveClass),this.buttonOnlinePayment.classList.add(this.buttonActiveClass)}))}render(){return this.element}dispose(){this.element.remove(),this.element=null}validate(t){var e;t.isAddressValid.isValid?this.errorMessage.textContent="":this.errorMessage.textContent=null!==(e=t.isAddressValid.message)&&void 0!==e?e:"",this.buttonNext.disabled=!(t.isAddressValid.isValid&&t.didPickPaymentType.isValid)}}class ContactInfo{constructor(t,e){this.element=cloneTemplate(t),this.inputEmail=this.element.querySelector('input[name="email"]'),this.inputPhone=this.element.querySelector('input[name="phone"]'),this.submitButton=this.element.querySelector('button[type="submit"]'),this.errorMessage=this.element.querySelector(".form__errors"),this.element.addEventListener("submit",(t=>{t.preventDefault(),e.emit(s.finishCreation)})),this.inputEmail.addEventListener("input",(()=>{e.emit(s.didChangeEmailInput,{input:this.inputEmail.value})})),this.inputPhone.addEventListener("input",(()=>{e.emit(s.didChangePhoneInput,{input:this.inputPhone.value})})),e.on(s.phoneValidation,(t=>{this.validate(t)})),e.on(s.emailValidation,(t=>{this.validate(t)}))}render(){return this.element}dispose(){this.element.remove(),this.element=null}validate(t){var e,i;console.log(t),t.isPhoneValid.isValid&&t.isEmailValid.isValid&&(this.errorMessage.textContent=""),t.isPhoneValid.isValid||(this.errorMessage.textContent=null!==(e=t.isPhoneValid.message)&&void 0!==e?e:""),t.isEmailValid.isValid||(this.errorMessage.textContent=null!==(i=t.isEmailValid.message)&&void 0!==i?i:""),this.submitButton.disabled=!(t.isPhoneValid.isValid&&t.isEmailValid.isValid)}}class TransactionModal{constructor(t,e){this.eventBroker=e,this.element=cloneTemplate(t),this.responseMessage=this.element.querySelector(".order-success__description"),this.element.querySelector(".order-success__close").addEventListener("click",(()=>{e.emit(i.clearCart),e.emit(r.close)}))}setError(t){this.responseMessage.textContent="Ошибка "+t}setData(t){this.responseMessage.textContent="Списано "+t.total+" синапсов"}render(){return this.element}dispose(){this.element.remove(),this.element=null}}class CartItem{constructor(t,e){this.eventBroker=e,this.element=t,this.index=this.element.querySelector(".basket__item-index"),this.title=this.element.querySelector(".card__title"),this.price=this.element.querySelector(".card__price"),this.deleteButton=this.element.querySelector(".basket__item-delete")}setData(t,e){this.index.textContent=t.toString(),this.title.textContent=e.title,e.price?this.price.textContent=e.price.toString():this.price.textContent="Бесценно",this.deleteButton.addEventListener("click",(()=>{this.eventBroker.emit(i.removeItem,e)}))}clone(){const t=this.element.cloneNode(!0);return new CartItem(t,this.eventBroker)}render(){return this.element}dispose(){var t;null===(t=this.element)||void 0===t||t.remove(),this.element=null}}!function(t){t.GET="GET",t.POST="POST"}(l||(l={}));class DefaultApiDataProvider{constructor(t,e={}){var i;this.baseUrl=t,this.options=Object.assign(Object.assign({},e),{headers:Object.assign({"Content-Type":"application/json"},null!==(i=e.headers)&&void 0!==i?i:{})})}async get(t){const e=this.baseUrl+t,i=Object.assign(Object.assign({},this.options),{method:l.GET}),s=await fetch(e,i);return await this.handleResponse(s)}async getBlob(t){const e=this.baseUrl+t,i=Object.assign(Object.assign({},this.options),{method:l.GET}),s=await fetch(e,i);return await s.blob()}async post(t,e){const i=this.baseUrl+t,s=JSON.stringify(e);console.log("TRY TO SEND ORDER:"+s);const n=Object.assign(Object.assign({},this.options),{method:l.POST,body:s}),r=await fetch(i,n);return await this.handleResponse(r)}async handleResponse(t){var e;const i=await t.json();if(t.ok)return i;throw new Error(null!==(e=i.error)&&void 0!==e?e:t.statusText)}}const d=new class EventEmitter{constructor(){this._events=new Map}on(t,e){var i;this._events.has(t)||this._events.set(t,new Set),null===(i=this._events.get(t))||void 0===i||i.add(e)}off(t,e){var i,s;this._events.has(t)&&(null===(i=this._events.get(t))||void 0===i||i.delete(e),0===(null===(s=this._events.get(t))||void 0===s?void 0:s.size)&&this._events.delete(t))}emit(t,e){this._events.forEach(((i,s)=>{(s instanceof RegExp&&s.test(t)||s===t)&&i.forEach((t=>t(e)))}))}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,e){return(i={})=>{this.emit(t,Object.assign(Object.assign({},i||{}),e||{}))}}},c=new DefaultApiDataProvider("https://larek-api.nomoreparties.co/api/weblarek"),h=new class DefaultRESTClient{constructor(t){this.api=t}async getAllProducts(){return(await this.api.get("/product")).items}async getProductById(t){return await this.api.get(`/product/${t}`)}async createOrder(t){return await this.api.post("/order",t)}}(c),m=new class ProductsData{constructor(t,e){this.productsList=[],this.eventsBroker=t,this.restClient=e}async getProducts(){if(this.productsList.length>0)return this.productsList;try{this.productsList=await this.restClient.getAllProducts()}catch(t){console.error(t)}return this.productsList=this.productsList.map((e=>Object.assign(Object.assign({},e),{image:t+e.image}))),this.eventsBroker.emit(e.didLoadProducts,this.productsList),this.productsList}async getProductById(i){var s;let n=this.productsList.find((t=>t.id===i));if(n)return n;try{n=await this.restClient.getProductById(i)}catch(t){console.error(t)}return n=Object.assign(Object.assign({},n),{image:t+(null!==(s=n.image)&&void 0!==s?s:"")}),this.eventsBroker.emit(e.didFindProductById,n),n}}(d,h),u=new DefaultApiDataProvider(t),p=(new class ImagesClient{constructor(t){this.api=t}async getProductImage(t){return await this.api.getBlob(t)}}(u),new class CartData{constructor(t){this.itemsInCart=[],this.eventsBroker=t,this.eventsBroker.on(i.addItem,(t=>{this.addItem(t)})),this.eventsBroker.on(i.removeItem,(t=>{this.removeItem(t)})),this.eventsBroker.on(i.initOrderCreation,(()=>{this.itemsInCart.length>0&&t.emit(s.collectPaymentInfo,this.itemsInCart)})),this.eventsBroker.on(i.clearCart,(()=>{this.removeAllItems()}))}addItem(t){this.itemsInCart.push(t),this.eventsBroker.emit(i.itemsChanged,this.itemsInCart)}removeItem(t){const e=this.itemsInCart.findIndex((e=>t.id===e.id));-1!==e&&this.itemsInCart.splice(e,1),this.eventsBroker.emit(i.itemsChanged,this.itemsInCart)}getItems(){return this.itemsInCart}isItemInCart(t){return-1!==this.itemsInCart.findIndex((e=>e.id===t))}removeAllItems(){this.itemsInCart=[],this.eventsBroker.emit(i.itemsChanged,this.itemsInCart)}}(d)),C=(new class OrderProcessor{constructor(t,e){this.order=null,this.eventsBroker=t,this.restClient=e,this.isPaymentValid={isAddressValid:{isValid:!1},didPickPaymentType:{isValid:!1}},this.isContactValid={isPhoneValid:{isValid:!1},isEmailValid:{isValid:!1}},t.on(s.collectPaymentInfo,(t=>{this.startOrderCreation(t)})),t.on(s.finishCreation,(async()=>{try{const i=await e.createOrder(this.order);t.emit(s.created,i)}catch(e){console.error(e),t.emit(s.notcreated,e.message)}})),t.on(s.didChangeAddressInput,(t=>{this.order.address=t.input,this.validateAddressInput(t.input)})),t.on(s.didSelectPaymentType,(t=>{this.order.payment=t.type,this.isPaymentValid=Object.assign(Object.assign({},this.isPaymentValid),{didPickPaymentType:{isValid:!0}}),this.eventsBroker.emit(s.paymentValidation,this.isPaymentValid)})),t.on(s.didChangeEmailInput,(t=>{this.order.email=t.input,this.validateEmailInput(t.input)})),t.on(s.didChangePhoneInput,(t=>{this.order.phone=t.input,this.validatePhoneInput(t.input)}))}startOrderCreation(t){this.order=new class{},this.order.items=t.map((t=>t.id)),t.some((t=>null==t.price))?this.order.total=1/0:this.order.total=t.reduce(((t,e)=>{var i;return t+(null!==(i=e.price)&&void 0!==i?i:0)}),0)}validateAddressInput(t){this.isPaymentValid=Object.assign(Object.assign({},this.isPaymentValid),{isAddressValid:{isValid:t.length>0,message:t.length>0?null:"Адрес не должен быть пустым!"}}),this.eventsBroker.emit(s.addressValidation,this.isPaymentValid)}validatePhoneInput(t){if(0===t.length)this.isContactValid=Object.assign(Object.assign({},this.isContactValid),{isPhoneValid:{isValid:!1,message:"Поле не должно быть пустым"}});else{const e=/^\+?[1-9]\d{1,14}$/.test(t);this.isContactValid=e?Object.assign(Object.assign({},this.isContactValid),{isPhoneValid:{isValid:!0,message:null}}):Object.assign(Object.assign({},this.isContactValid),{isPhoneValid:{isValid:!1,message:"Не валидный номер телефона"}})}this.eventsBroker.emit(s.phoneValidation,this.isContactValid)}validateEmailInput(t){if(0===t.length)this.isContactValid=Object.assign(Object.assign({},this.isContactValid),{isEmailValid:{isValid:!1,message:"Поле не должно быть пустым"}});else{const e=/^[\w-.]+@([\w-]+\.)+[\w-]{2,4}$/.test(t);this.isContactValid=e?Object.assign(Object.assign({},this.isContactValid),{isEmailValid:{isValid:!0,message:null}}):Object.assign(Object.assign({},this.isContactValid),{isEmailValid:{isValid:!1,message:"невалидный e-mail"}})}this.eventsBroker.emit(s.emailValidation,this.isContactValid)}}(d,h),document.querySelector(".page"));new class Page{constructor(t,e,i,a){this.element=t,this.eventBroker=e;const o=t.querySelector(".header");this.pageHead=new PageHeader(o,e);const l=t.querySelector("#modal-container");this.modalContainer=new ModalContainer(l,e);const d=t.querySelector(".gallery");this.pageGallery=new PageGallery(d,e),e.on(n.didSelectItem,(async t=>{const e=await i.getProductById(t.id);this.openCardPreview(e)})),e.on(n.didClickOpenCart,(()=>{this.openCartModal(a.getItems())})),e.on(s.collectPaymentInfo,(()=>{this.modalContainer.close(),this.openPaymentModal()})),e.on(s.collectContactInfo,(()=>{this.modalContainer.close(),this.openContactModal()})),e.on(s.created,(t=>{this.openTransactionModal(t)})),e.on(r.close,(()=>{this.modalContainer.close()}))}openCardPreview(t){const e=this.element.querySelector("#card-preview"),i=new ProductCardPreview(e,this.eventBroker);i.setData(t),this.modalContainer.setContent(i),this.modalContainer.open()}openCartModal(t){const e=this.element.querySelector("#basket"),i=cloneTemplate(this.element.querySelector("#card-basket")),s=new CartItem(i,this.eventBroker),n=new Cart(e,s,this.eventBroker);n.setData(t),this.modalContainer.setContent(n),this.modalContainer.open()}openPaymentModal(){const t=this.element.querySelector("#order"),e=new PaymentInfo(t,this.eventBroker);this.modalContainer.setContent(e),this.modalContainer.open()}openContactModal(){const t=this.element.querySelector("#contacts"),e=new ContactInfo(t,this.eventBroker);this.modalContainer.setContent(e),this.modalContainer.open()}openTransactionModal(t){const e=this.element.querySelector("#success"),i=new TransactionModal(e,this.eventBroker);t instanceof Error?i.setError(t.message):i.setData(t),this.modalContainer.setContent(i),this.modalContainer.open()}}(C,d,m,p);m.getProducts().then()})();
//# sourceMappingURL=main.js.map